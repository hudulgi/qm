# Quantitative Momentum Strategies - FIP & GEM 자동화 시스템

한국투자증권 OpenAPI(PyKis)를 활용하여 두 가지 모멘텀 전략을 자동으로 실행하는 시스템입니다:
- **FIP 전략**: Wesley Gray의 "Quantitative Momentum" 책에 소개된 FIP(Financial Statement Quality) 기반 포트폴리오 투자
- **GEM 전략**: Gary Antonacci의 "Dual Momentum" 책에 소개된 GEM(Global Equities Momentum) 듀얼모멘텀 투자

## 목차

- [주요 기능](#주요-기능)
- [필수 요구사항](#필수-요구사항)
- [설치 방법](#설치-방법)
- [설정 파일](#설정-파일)
- [프로그램 설명](#프로그램-설명)
  - [1. find_item_fip.py - FIP 포트폴리오 종목 선정](#1-find_item_fippy---fip-포트폴리오-종목-선정)
  - [2. buy_fip.py - FIP 전략 자동 리밸런싱](#2-buy_fippy---fip-전략-자동-리밸런싱)
  - [3. buy_gem.py - GEM 전략 자동 실행](#3-buy_gempy---gem-전략-자동-실행)
- [사용 예시](#사용-예시)
- [주의사항](#주의사항)
- [로그 및 실행 기록](#로그-및-실행-기록)

---

## 주요 기능

### 1. FIP 전략 자동 리밸런싱 (`buy_fip.py`)
- ✅ 분기별(3, 6, 9, 12월) 자동 리밸런싱
- ✅ 균등 투자 방식 (종목당 동일 금액 투자)
- ✅ 보유 종목 자동 조정 (매도/매수/유지)
- ✅ 월 1회 실행 제한 (중복 실행 방지)

### 2. GEM 전략 자동 실행 (`buy_gem.py`)
- ✅ 12개월 토탈리턴 분석 (가격 변동 + 배당)
- ✅ 최고 수익률 종목에 전액 투자
- ✅ 자동 리밸런싱 (기존 종목 매도 후 새 종목 매수)
- ✅ 월 1회 실행 제한

### 공통 기능
- ✅ 실전/모의투자 모드 지원
- ✅ 재시도 로직 (네트워크 오류 대응)
- ✅ 상세한 로그 기록 (콘솔 + 파일)
- ✅ 호가 단위 자동 조정
- ✅ 실행 기록 관리 (JSON)

---

## 필수 요구사항

### Python 버전
- Python 3.7 이상

### 필수 패키지
```bash
pip install pykis pandas
```

### 한국투자증권 계좌
- 한국투자증권 계좌 개설
- OpenAPI 신청 (실전투자/모의투자)
- App Key 및 App Secret 발급

---

## 설치 방법

### 1. 저장소 클론
```bash
git clone <repository-url>
cd qm
```

### 2. 패키지 설치
```bash
pip install -r requirements.txt
```

또는 개별 설치:
```bash
pip install pykis pandas
```

### 3. 디렉토리 구조 생성
```bash
mkdir -p portfolio logs
```

---

## 설정 파일

### PyKis 인증 파일 생성

본 프로젝트는 [python-kis](https://github.com/Soju06/python-kis) 라이브러리를 사용합니다.
인증 파일은 다음과 같이 생성합니다:

#### 실전투자 계좌 (secret.json)
```python
from pykis import KisAuth

auth = KisAuth(
    id="HTS_ID",                    # HTS 로그인 ID
    appkey="YOUR_APP_KEY",          # 실전투자 App Key (36자)
    secretkey="YOUR_APP_SECRET",    # 실전투자 App Secret (180자)
    account="12345678-01",          # 계좌번호 (형식: 8자리-01)
    virtual=False,                  # 실전투자
)

auth.save("secret.json")
```

#### 모의투자 계좌 (secret_virtual.json, 옵션)
```python
from pykis import KisAuth

auth = KisAuth(
    id="HTS_ID",                    # HTS 로그인 ID
    appkey="YOUR_VIRTUAL_APP_KEY",  # 모의투자 App Key
    secretkey="YOUR_VIRTUAL_SECRET",# 모의투자 App Secret
    account="12345678-01",          # 모의계좌번호
    virtual=True,                   # 모의투자
)

auth.save("secret_virtual.json")
```

**참고**: 자세한 설정 방법은 [python-kis 공식 문서](https://github.com/Soju06/python-kis)를 참조하세요.

---

## 프로그램 설명

## 1. find_item_fip.py - FIP 포트폴리오 종목 선정

### 개요
- **목적**: FIP 전략에 따라 투자할 종목을 자동으로 선정
- **선정 기준**:
  - KOSPI200 섹터업종 + KOSDAQ150 지수 종목 중
  - 수정 12개월 모멘텀 상위 100개 종목 선정
  - 그 중 FIP(Financial Statement Quality) 하위 10개 최종 선정
- **출력**: `portfolio/portfolio_YYYY-MM-DD.csv` 파일 생성

### FIP 지표란?
Wesley Gray의 "Quantitative Momentum" 책에 소개된 지표로:
- **FIP = 모멘텀 부호 × (음봉 비율 - 양봉 비율)**
- 모멘텀이 높으면서도 FIP가 낮은 종목은:
  - 급등주가 아닌 꾸준한 상승세
  - 향후 변동성이 낮고 지속 가능한 수익 기대

### 주요 기능
1. **종목 코드 다운로드**:
   - KOSPI200 섹터업종 종목 필터링
   - KOSDAQ150 지수 종목 필터링
   - 한국거래소(KRX) 마스터 파일 자동 다운로드

2. **모멘텀 및 FIP 계산**:
   - 수정 12개월 모멘텀: 최근 12개월 중 마지막 달 제외한 11개월 수익률
   - FIP: 12개월간 일간 수익률의 양봉/음봉 비율 기반

3. **포트폴리오 생성**:
   - 모멘텀 상위 100개 중 FIP 하위 10개 선정
   - 종목 정보를 CSV 파일로 저장

### 명령줄 옵션

| 옵션 | 필수 | 설명 | 예시 |
|------|------|------|------|
| `--secret` | ✅ | KIS API secret 파일 경로 | `--secret secret.json` |

### 사용 예시

```bash
# 최신 거래일 기준으로 포트폴리오 생성
python find_item_fip.py --secret secret.json
```

### 출력 예시
```
==================================================
모멘텀 계산용 종목 코드 다운로드
==================================================
KOSPI 종목 필터링: 전체 974개 중 KOSPI200섹터업종 200개 선택
KOSDAQ 종목 필터링: 전체 1625개 중 KOSDAQ150 150개 선택

모멘텀 계산 대상 종목 350개

==================================================
포트폴리오 선정
==================================================
설정: 모멘텀 상위 100개 중 FIP 하위 10개 선정

마지막 거래일: 2025-11-22 (5개 종목에서 확인)

진행률: 50/350
진행률: 100/350
...
진행률: 350/350

선정된 10개 종목:
  005930 삼성전자: 모멘텀 18.50%, FIP -0.2145
  000660 SK하이닉스: 모멘텀 22.30%, FIP -0.1987
  ...

포트폴리오가 portfolio/portfolio_2025-11-22.csv에 저장되었습니다.
```

### 생성되는 파일
- **위치**: `portfolio/portfolio_YYYY-MM-DD.csv`
- **형식**:
  ```csv
  code,종목명,end_price,adjusted_momentum_12m,fip,end_price_date
  005930,삼성전자,70000,18.50,-0.2145,2025-11-22
  000660,SK하이닉스,130000,22.30,-0.1987,2025-11-22
  ```

### 실행 주기
- **권장**: 분기별 리밸런싱 전 (3월, 6월, 9월, 12월 초)
- 포트폴리오 생성 후 `buy_fip.py`로 자동 매매 실행

---

## 2. buy_fip.py - FIP 전략 자동 리밸런싱

### 개요
- **목적**: 분기별(3, 6, 9, 12월)로 포트폴리오를 자동으로 리밸런싱
- **투자 방식**: 균등 투자 (총 투자액을 종목 수로 나누어 동일하게 투자)
- **실행 제한**: 월 1회 (중복 실행 방지)

### 주요 기능
1. **포트폴리오 파일 자동 선택**: `portfolio/` 폴더에서 가장 최신 파일 자동 선택
2. **리밸런싱 로직**:
   - 매수 예정에 없는 보유 종목: 전량 매도
   - 보유량 > 목표량: 차액만큼 매도
   - 보유량 < 목표량: 차액만큼 매수
   - 보유량 = 목표량: 유지 (거래 없음)
3. **매수 방식**: 최우선 지정가 (실전투자는 price=0, 모의투자는 상한가 지정)
4. **매도 방식**: 시장가 매도

### 포트폴리오 파일 형식
`portfolio/portfolio_YYYY-MM-DD.csv` 파일에 다음 형식으로 작성:

```csv
code,종목명,end_price,adjusted_momentum_12m,fip,end_price_date
005930,삼성전자,70000,15.5,0.85,2025-11-20
000660,SK하이닉스,130000,20.3,0.90,2025-11-20
035420,NAVER,200000,18.7,0.88,2025-11-20
```

**필수 컬럼**:
- `code`: 종목코드 (6자리)
- `종목명`: 종목명
- `end_price`: 종가 (전일 종가)
- `adjusted_momentum_12m`: 12개월 모멘텀 (옵션)
- `fip`: FIP 지표 (옵션)
- `end_price_date`: 종가 날짜 (옵션)

### 명령줄 옵션

| 옵션 | 필수 | 설명 | 예시 |
|------|------|------|------|
| `--secret` | ✅ | 실전 계좌 secret 파일 경로 | `--secret secret.json` |
| `--execute` | ❌ | 실제 주문 실행 (없으면 계획만 출력) | `--execute` |
| `--virtual` | ❌ | 모의투자 계좌 secret 파일 경로 | `--virtual secret_virtual.json` |
| `--investment` | ❌ | 총 투자액 (원 단위, 기본: 현재 총평가금액) | `--investment 10000000` |
| `--force` | ❌ | 월 및 리밸런싱 제한 무시하고 강제 실행 | `--force` |

### 사용 예시

#### 1. 매수 계획만 확인 (주문 실행 안함)
```bash
python buy_fip.py --secret secret.json
```

#### 2. 실전투자 계좌에서 실제 주문 실행 (현재 총평가금액으로 투자)
```bash
python buy_fip.py --secret secret.json --execute
```

#### 3. 모의투자 계좌에서 1천만원으로 테스트
```bash
python buy_fip.py --secret secret.json --virtual secret_virtual.json --investment 10000000 --execute
```

#### 4. 강제 실행 (월 제한 무시)
```bash
python buy_fip.py --secret secret.json --execute --force
```

### 출력 예시
```
================================================================================
포트폴리오 리밸런싱
실행 시각: 2025-12-01 09:00:00
================================================================================

✅ 현재 월(12월)은 리밸런싱 월입니다.
✅ 이번 달(2025-12) 첫 실행입니다.

최신 포트폴리오 파일: portfolio_2025-12-01.csv

총 투자액: 10,000,000원
종목 수: 5개
종목당 투자액: 2,000,000원

================================================================================
매수 계획
================================================================================

종목코드     종목명                       가격       수량          투자액          실투자액
--------------------------------------------------------------------------------
005930     삼성전자                    70,000       28       2,000,000       1,960,000
000660     SK하이닉스                 130,000       15       2,000,000       1,950,000
...

매수 계획이 portfolio/fip_plan_2025-12-01.csv에 저장되었습니다.

💡 매수 주문을 실행하려면 --execute 옵션을 사용하세요.
```

### 실행 조건
- **리밸런싱 월**: 3월, 6월, 9월, 12월만 실행
- **월 1회 제한**: 같은 달에 이미 실행된 경우 종료
- `--force` 옵션으로 제한 무시 가능

---

## 3. buy_gem.py - GEM 전략 자동 실행

### 개요
- **전략명**: GEM (Global Equities Momentum)
- **투자 방식**: 12개월 토탈리턴이 가장 높은 종목에 전액 투자
- **토탈리턴**: 가격 변동 수익률 + 배당 수익률
- **실행 제한**: 전략별 월 1회 (같은 달에 여러 전략 실행 가능)

### 주요 기능
1. **전략 설정 파일 시스템**:
   - JSON 파일로 전략 관리
   - 여러 전략을 독립적으로 실행 가능
   - 전략별 실행 기록 관리
2. **12개월 토탈리턴 분석**:
   - NAV 가격 변동 수익률 계산
   - 배당금 수익률 포함
   - 전략 설정 파일의 종목들 비교 분석
3. **자동 리밸런싱**:
   - 기존 보유 종목 전량 매도
   - 최고 수익률 종목 전액 매수
   - 이미 보유 중인 경우 예수금으로 추가 매수
4. **매수 방식**: 지정가 매수 (현재가)
5. **매도 방식**: 시장가 매도

### 전략 설정 파일

각 전략은 JSON 파일로 정의합니다:

#### strategy_kodex.json 예시
```json
{
  "name": "KODEX 전략",
  "target_codes": ["069500", "379810", "153130"],
  "description": "KODEX 200, KODEX 미국S&P500TR, KODEX 미국나스닥100TR"
}
```

#### strategy_tiger.json 예시
```json
{
  "name": "TIGER 전략",
  "target_codes": ["292190", "379810", "153130"],
  "description": "TIGER 200, KODEX 미국S&P500TR, KODEX 미국나스닥100TR"
}
```

**필수 필드**:
- `name`: 전략 이름 (실행 기록 구분에 사용)
- `target_codes`: 비교할 종목 코드 리스트
- `description`: 전략 설명 (옵션)

> ⚠️ **중요**: 위 종목들은 **코드 동작 확인을 위한 예시**입니다.
> - 특정 종목 추천이 아니며, 실제 투자 시 본인의 투자 성향과 목표에 맞는 종목으로 변경해야 합니다.
> - GEM 전략에 적합한 ETF를 직접 선택하여 전략 설정 파일을 생성하세요.
> - 예: 국내/해외 지수 추종 ETF, 섹터별 ETF 등

### 명령줄 옵션

| 옵션 | 필수 | 설명 | 예시 |
|------|------|------|------|
| `--secret` | ✅ | 실전 계좌 secret 파일 경로 | `--secret secret.json` |
| `--strategy` | ✅ | 전략 설정 JSON 파일 경로 | `--strategy strategy_kodex.json` |
| `--execute` | ❌ | 실제 주문 실행 (없으면 분석만 수행) | `--execute` |
| `--virtual` | ❌ | 모의투자 계좌 secret 파일 경로 | `--virtual secret_virtual.json` |
| `--investment` | ❌ | 총 투자액 (원 단위, 기본: 현재 총평가금액) | `--investment 10000000` |
| `--force` | ❌ | 월 제한 무시하고 강제 실행 | `--force` |

### 사용 예시

#### 1. KODEX 전략 분석만 수행 (주문 실행 안함)
```bash
python buy_gem.py --secret secret.json --strategy strategy_kodex.json
```

#### 2. KODEX 전략 실전투자 실행 (현재 총평가금액으로 투자)
```bash
python buy_gem.py --secret secret.json --strategy strategy_kodex.json --execute
```

#### 3. TIGER 전략 모의투자로 테스트 (1천만원)
```bash
python buy_gem.py --secret secret.json --strategy strategy_tiger.json --virtual secret_virtual.json --investment 10000000 --execute
```

#### 4. 강제 실행 (월 제한 무시)
```bash
python buy_gem.py --secret secret.json --strategy strategy_kodex.json --execute --force
```

#### 5. 같은 달에 여러 전략 실행
```bash
# KODEX 전략 실행
python buy_gem.py --secret secret.json --strategy strategy_kodex.json --execute

# TIGER 전략도 실행 가능 (전략별로 구분되어 관리됨)
python buy_gem.py --secret secret.json --strategy strategy_tiger.json --execute
```

### 출력 예시
```
================================================================================
GEM(Global Equities Momentum) 전략 시작
================================================================================

🔐 인증 중...
인증 완료

================================================================================
종목명 조회 중...
================================================================================
  - 069500: KODEX 200
  - 379800: KODEX 미국S&P500
  - 423160: KODEX KOFR금리액티브(합성)

================================================================================
📊 GEM 전략 - 12개월 토탈리턴 분석
================================================================================
분석 종목: 3개

--------------------------------------------------------------------------------
종목 분석: 069500 (KODEX 200)
--------------------------------------------------------------------------------
✅ 12개월 토탈리턴: 18.50%
   가격 수익률: 17.20%
   배당 수익률: 1.30%

--------------------------------------------------------------------------------
종목 분석: 379800 (KODEX 미국S&P500)
--------------------------------------------------------------------------------
✅ 12개월 토탈리턴: 25.30%
   가격 수익률: 24.80%
   배당 수익률: 0.50%

--------------------------------------------------------------------------------
종목 분석: 423160 (KODEX KOFR금리액티브(합성))
--------------------------------------------------------------------------------
✅ 12개월 토탈리턴: -5.20%
   가격 수익률: -5.50%
   배당 수익률: 0.30%

================================================================================
📈 분석 결과 요약
================================================================================

순위   종목코드     종목명                           12개월 토탈리턴
--------------------------------------------------------------------------------
🥇 1   379800     KODEX 미국S&P500                        25.30%
   2   069500     KODEX 200                              18.50%
   3   423160     KODEX KOFR금리액티브(합성)              -5.20%

================================================================================
🎯 선택 종목: 379800 (KODEX 미국S&P500)
   12개월 토탈리턴: 25.30%
================================================================================

💡 실제 주문을 실행하려면 --execute 옵션을 사용하세요.
```

### 투자 로직
1. **보유 종목이 없는 경우**: 총평가금액의 99%로 전액 매수
2. **목표 종목을 이미 보유한 경우**: 예수금으로 추가 매수
3. **다른 종목을 보유한 경우**: 전량 매도 후 목표 종목 매수

---

## 사용 예시

### 정기 실행 (crontab)
```bash
# 매월 첫 거래일 09시 05분에 FIP 전략 리밸런싱 실행
5 9 1 3,6,9,12 * cd /path/to/qm && python buy_fip.py --secret secret.json --execute

# 매월 1일 09시 10분에 KODEX 전략 실행
10 9 1 * * cd /path/to/qm && python buy_gem.py --secret secret.json --strategy strategy_kodex.json --execute

# 매월 1일 09시 15분에 TIGER 전략 실행
15 9 1 * * cd /path/to/qm && python buy_gem.py --secret secret.json --strategy strategy_tiger.json --execute
```

### 수동 실행 워크플로우
1. **테스트 (모의투자)**
   ```bash
   python buy_fip.py --secret secret.json --virtual secret_virtual.json --investment 10000000
   ```

2. **계획 확인**
   ```bash
   python buy_fip.py --secret secret.json
   ```

3. **실전 실행**
   ```bash
   python buy_fip.py --secret secret.json --execute
   ```

---

## 주의사항

### 1. 투자 리스크
- ⚠️ 본 프로그램은 자동으로 매매 주문을 실행합니다.
- ⚠️ 투자에 따른 손실은 전적으로 사용자의 책임입니다.
- ⚠️ 실전 투자 전 반드시 모의투자에서 충분히 테스트하세요.

### 2. 실행 제한
- `buy_fip.py`: 3, 6, 9, 12월에만 실행 (--force로 무시 가능)
- 두 프로그램 모두 월 1회 실행 제한 (--force로 무시 가능)
- 중복 실행 방지를 위해 실행 기록 파일 확인

### 3. 계좌 설정
- `secret.json` 파일에는 실전투자 계좌 정보만 입력
- 모의투자는 별도 파일(`secret_virtual.json`) 사용
- **절대 secret 파일을 GitHub에 커밋하지 마세요!**

### 4. API 호출 제한
- 한국투자증권 OpenAPI는 초당 호출 횟수 제한이 있습니다.
- 프로그램 내부에 딜레이 로직이 포함되어 있습니다.

### 5. 포트폴리오 파일
- `buy_fip.py`는 `portfolio/` 폴더에서 가장 최신 파일을 자동 선택
- 파일명 형식: `portfolio_YYYY-MM-DD.csv`
- 포트폴리오 생성 스크립트는 별도로 실행 필요

---

## 로그 및 실행 기록

### 로그 파일
- **위치**: `logs/` 폴더
- **형식**:
  - `fip_YYYYMMDD_HHMMSS.log`
  - `gem_YYYYMMDD_HHMMSS.log`
- **내용**: 콘솔 출력과 동일 + 디버그 정보

### 실행 기록 파일
- **FIP 전략**: `fip_execution_log.json`
- **GEM 전략**: `gem_execution_log.json`
- **내용**: 실행 날짜, 포트폴리오/선택 종목, 성공 여부

### 매수 결과 파일
- **위치**: `portfolio/` 폴더
- **파일명**:
  - `fip_plan_YYYY-MM-DD.csv` (FIP 전략 매수 계획)
  - `fip_results_YYYY-MM-DD.csv` (FIP 전략 주문 결과)

---

## 라이선스

MIT License

---

## 문의

이슈 및 질문은 GitHub Issues를 이용해주세요.